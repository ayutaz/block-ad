# 広告ブロックアプリ仕様書

## 1. アプリケーション概要

### 1.1 目的
本アプリケーションは、Android/iOSデバイスにおいて、Webサイトおよび動画コンテンツ（YouTube含む）の広告を完全にブロックすることを目的とする。

### 1.2 基本要件
- **完全無料**: 広告表示なし、アプリ内課金なし
- **高速動作**: 起動時間1秒以内、メモリ使用量30MB以下
- **YouTube対応**: YouTube動画広告の80%以上をブロック
- **プライバシー保護**: ユーザーデータの収集・送信なし

## 2. 機能仕様

### 2.1 コア機能

#### F-001: 広告ブロック機能
**説明**: URLベースおよびコンテンツベースの広告ブロック

**受け入れ条件**:
- 既知の広告配信ドメインからのリクエストを100%ブロックできる
- ブロック判定は10ms以内に完了する
- ブロックしたリクエストは適切な空レスポンスを返す

**詳細仕様**:
```
入力: HTTPリクエスト（URL、ヘッダー、送信元アプリ）
処理: 
  1. URLパターンマッチング（ドメイン、パス）
  2. ヘッダー解析
  3. ブロック判定
出力: ブロック判定結果（許可/ブロック/修正）
```

#### F-002: YouTube広告ブロック機能
**説明**: YouTube動画の広告（プレロール、ミッドロール、オーバーレイ）をブロック

**受け入れ条件**:
- プレロール広告を100%スキップできる
- 動画内広告区間を検出し自動スキップできる
- オーバーレイ広告を非表示にできる

**詳細仕様**:
```
対象URL: 
  - youtube.com, m.youtube.com
  - youtu.be
処理:
  1. 広告リクエストのブロック
  2. プレーヤースクリプトの改変
  3. 広告要素のCSS非表示化
```

#### F-003: 統計機能
**説明**: ブロック実績の記録と表示

**受け入れ条件**:
- ブロック数、節約データ量をリアルタイム集計できる
- 過去24時間/7日間/30日間の統計を表示できる
- ドメイン別のブロック数TOP10を表示できる

**データ構造**:
```typescript
interface Statistics {
  totalBlocked: number;      // 総ブロック数
  totalAllowed: number;      // 総許可数
  dataSaved: number;         // 節約データ量（バイト）
  timeActive: number;        // アクティブ時間（秒）
  domainStats: Map<string, number>; // ドメイン別統計
}
```

### 2.2 プラットフォーム固有機能

#### F-101: Android VPNサービス
**説明**: ローカルVPNとして動作し、全アプリの通信を監視

**受け入れ条件**:
- VPN接続が5秒以内に確立される
- 接続中の通信速度低下が5%以内
- バックグラウンドで安定動作する

#### F-102: iOS Network Extension
**説明**: システムレベルでパケットをフィルタリング

**受け入れ条件**:
- Network Extensionが正常に起動する
- システムの安定性に影響を与えない
- バッテリー消費が通常使用時の110%以内

### 2.3 ユーザーインターフェース

#### UI-001: メイン画面
**要素**:
- 広告ブロックON/OFFトグル
- 現在の状態表示（有効/無効）
- 本日のブロック数表示
- 設定ボタン

**動作仕様**:
- トグル操作は即座に反映される（100ms以内）
- 状態変更時はアニメーション表示
- ブロック数は1秒ごとに更新

#### UI-002: 統計画面
**要素**:
- 期間別統計グラフ
- ドメイン別ランキング
- 節約データ量表示

#### UI-003: 設定画面
**要素**:
- 除外アプリリスト
- カスタムルール追加
- ルール更新間隔設定
- バージョン情報

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### P-001: 起動時間
- コールドスタート: 1秒以内
- ホットスタート: 100ms以内

#### P-002: メモリ使用量
- 通常時: 30MB以下
- ピーク時: 50MB以下

#### P-003: CPU使用率
- アイドル時: 0.1%以下
- アクティブ時: 5%以下

#### P-004: バッテリー消費
- 24時間で全体の3%以下

### 3.2 信頼性要件

#### R-001: 可用性
- 99.9%以上の稼働率
- クラッシュ率0.1%以下

#### R-002: データ整合性
- 統計データの欠損なし
- 設定の永続化保証

### 3.3 セキュリティ要件

#### S-001: 通信セキュリティ
- ルール更新時はHTTPS必須
- 証明書検証の実施

#### S-002: プライバシー保護
- ログのローカル保存のみ
- 個人情報の収集禁止
- 通信内容の記録禁止

## 4. 制約事項

### 4.1 技術的制約
- Android: VPN API使用のため、他VPNアプリとの併用不可
- iOS: Network Extension使用のため、有料開発者アカウント必須

### 4.2 プラットフォーム制約
- Android: 最小API Level 24（Android 7.0）
- iOS: 最小バージョン iOS 15.0

### 4.3 配布制約
- Android: Google Play Store配布不可（APK直接配布）
- iOS: App Store審査通過困難（TestFlight/サイドロード）

## 5. 受け入れテスト基準

### 5.1 機能テスト
1. 主要広告ネットワーク（Google Ads、Facebook等）のブロック率95%以上
2. YouTube広告ブロック率80%以上
3. 正常なコンテンツの誤ブロック率0.1%以下

### 5.2 性能テスト
1. 1000件/秒のリクエスト処理能力
2. 10万件のルールで判定時間10ms以内
3. 24時間連続動作での安定性

### 5.3 ユーザビリティテスト
1. 初回セットアップ3タップ以内
2. 主要機能へのアクセス2タップ以内

## 6. フィルタールール仕様

### 6.1 ルール形式
```json
{
  "version": "1.0.0",
  "rules": [
    {
      "id": "rule_001",
      "type": "url_pattern",
      "pattern": "||doubleclick.net^",
      "action": "block",
      "priority": 1000,
      "metadata": {
        "category": "tracking",
        "source": "easylist"
      }
    },
    {
      "id": "rule_002",
      "type": "css_selector",
      "selector": ".ad-container, .sponsored",
      "domains": ["example.com"],
      "action": "hide"
    },
    {
      "id": "rule_003",
      "type": "script_injection",
      "script": "(() => { /* code */ })()",
      "domains": ["youtube.com"],
      "timing": "document_start"
    }
  ]
}
```

### 6.2 ルール優先度
1. ホワイトリスト（優先度: 10000）
2. ユーザーカスタムルール（優先度: 5000）
3. システムルール（優先度: 1000）
4. サードパーティルール（優先度: 100）

## 7. エラー処理仕様

### 7.1 エラー分類
- **E1xxx**: 初期化エラー
- **E2xxx**: ネットワークエラー
- **E3xxx**: フィルタリングエラー
- **E4xxx**: プラットフォームエラー

### 7.2 エラー処理方針
1. ユーザーへの影響を最小化
2. 自動リトライ（最大3回）
3. フォールバック動作の実装
4. エラーログのローカル保存

## 8. 状態遷移

### 8.1 アプリケーション状態
```
[初期状態] → [初期化中] → [待機中]
                ↓            ↓
              [エラー]    [ブロック中]
                            ↓
                          [一時停止]
```

### 8.2 VPN/Extension状態
```
[未接続] → [接続中] → [接続済み]
    ↑         ↓          ↓
    ←────[切断中]←────────┘
```

## 9. データ仕様

### 9.1 永続化データ
- 設定情報（JSON形式）
- 統計情報（SQLite）
- フィルタールール（圧縮バイナリ）
- ブロックログ（循環バッファ、最大1000件）

### 9.2 一時データ
- パケットバッファ（メモリ）
- DNSキャッシュ（LRU、最大1000件）
- 判定結果キャッシュ（TTL: 60秒）

## 10. 国際化対応

### 10.1 対応言語
- 日本語（ja）
- 英語（en）

### 10.2 ローカライズ項目
- UI文字列
- エラーメッセージ
- 統計表示形式（数値、日付）